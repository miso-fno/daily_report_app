// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 日報ステータス
enum ReportStatus {
  draft // 下書き
  submitted // 提出済
  confirmed // 確認済
}

// 営業担当者
model SalesPerson {
  id         Int      @id @default(autoincrement()) @map("sales_person_id")
  name       String   @db.VarChar(50)
  email      String   @unique @db.VarChar(255)
  password   String   @db.VarChar(255)
  department String   @db.VarChar(100)
  managerId  Int?     @map("manager_id")
  isManager  Boolean  @default(false) @map("is_manager")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // 自己参照リレーション（上長-部下）
  manager      SalesPerson?  @relation("ManagerSubordinates", fields: [managerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subordinates SalesPerson[] @relation("ManagerSubordinates")

  // 日報リレーション
  dailyReports DailyReport[]

  // コメントリレーション
  comments Comment[]

  // パフォーマンス最適化: 頻繁に検索されるカラムにインデックス
  @@index([managerId]) // 部下の取得時に使用
  @@index([department]) // 部署でのフィルタリング
  @@index([isManager]) // 上長の一覧取得
  @@index([createdAt]) // 作成日時でのソート
  @@map("sales_persons")
}

// 顧客
model Customer {
  id            Int      @id @default(autoincrement()) @map("customer_id")
  customerName  String   @map("customer_name") @db.VarChar(100)
  address       String?  @db.VarChar(200)
  phone         String?  @db.VarChar(20)
  contactPerson String?  @map("contact_person") @db.VarChar(50)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // 訪問記録リレーション
  visitRecords VisitRecord[]

  // パフォーマンス最適化: 顧客名検索の高速化
  @@index([customerName]) // 顧客名での検索・ソート
  @@index([createdAt]) // 作成日時でのソート
  @@map("customers")
}

// 日報
model DailyReport {
  id            Int          @id @default(autoincrement()) @map("report_id")
  salesPersonId Int          @map("sales_person_id")
  reportDate    DateTime     @map("report_date") @db.Date
  problem       String?      @db.Text
  plan          String?      @db.Text
  status        ReportStatus @default(draft)
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // 営業担当者リレーション
  salesPerson SalesPerson @relation(fields: [salesPersonId], references: [id], onDelete: Cascade)

  // 訪問記録リレーション
  visitRecords VisitRecord[]

  // コメントリレーション
  comments Comment[]

  // 同一営業担当者の同一日付の日報は1件のみ
  @@unique([salesPersonId, reportDate])
  // パフォーマンス最適化: 日報検索・一覧表示の高速化
  @@index([salesPersonId]) // 営業担当者別の日報取得
  @@index([reportDate]) // 日付範囲での検索
  @@index([status]) // ステータスでのフィルタリング
  @@index([createdAt]) // 作成日時でのソート
  @@index([salesPersonId, status]) // 営業担当者とステータスの複合検索
  @@index([reportDate, status]) // 日付とステータスの複合検索
  @@map("daily_reports")
}

// 訪問記録
model VisitRecord {
  id           Int       @id @default(autoincrement()) @map("visit_id")
  reportId     Int       @map("report_id")
  customerId   Int       @map("customer_id")
  visitTime    DateTime? @map("visit_time") @db.Time()
  visitPurpose String?   @map("visit_purpose") @db.VarChar(100)
  visitContent String    @map("visit_content") @db.Text
  visitResult  String?   @map("visit_result") @db.VarChar(200)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // 日報リレーション
  dailyReport DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // 顧客リレーション
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  // パフォーマンス最適化: 訪問記録の検索高速化
  @@index([reportId]) // 日報別の訪問記録取得（N+1対策）
  @@index([customerId]) // 顧客別の訪問履歴取得
  @@index([createdAt]) // 作成日時でのソート
  @@map("visit_records")
}

// コメント
model Comment {
  id            Int      @id @default(autoincrement()) @map("comment_id")
  reportId      Int      @map("report_id")
  salesPersonId Int      @map("sales_person_id")
  commentText   String   @map("comment_text") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // 日報リレーション
  dailyReport DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // コメント投稿者（営業担当者）リレーション
  salesPerson SalesPerson @relation(fields: [salesPersonId], references: [id], onDelete: Cascade)

  // パフォーマンス最適化: コメント検索の高速化
  @@index([reportId]) // 日報別のコメント取得（N+1対策）
  @@index([salesPersonId]) // コメント投稿者別の取得
  @@index([createdAt]) // 作成日時でのソート（新着順表示）
  @@map("comments")
}
